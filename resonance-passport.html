<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>ü™™ –†–µ–∑–æ–Ω–∞–Ω—Å-–ü–∞—Å–ø–æ—Ä—Ç</title>
  <style>
    body {
      background: #0c0c0c;
      color: #eee;
      font-family: 'Segoe UI', sans-serif;
      padding: 30px;
      max-width: 800px;
      margin: auto;
    }
    h2 { text-align: center; }
    button, input[type="file"] {
      background: #1a1a1a;
      color: #eee;
      padding: 10px;
      border: 1px solid #444;
      margin: 10px auto;
      display: block;
      cursor: pointer;
    }
    canvas {
      display: block;
      margin: 20px auto;
      border: 1px solid #555;
      background: #000;
    }
    pre {
      background: #111;
      padding: 10px;
      overflow-x: auto;
      margin-top: 20px;
    }
    #info { text-align: center; margin-top: 20px; }
  </style>
</head>
<body>
  <h2>ü™™ –°—Ç–≤–æ—Ä–∏—Ç–∏ –†–µ–∑–æ–Ω–∞–Ω—Å-–ü–∞—Å–ø–æ—Ä—Ç</h2>
  <p style="text-align:center;">–ó–∞–≤–∞–Ω—Ç–∞–∂ —Ñ–∞–π–ª –∞–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–π –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π –≥–ª—ñ—Ñ.</p>

  <input type="file" accept=".json" onchange="loadGlyph(event)">
  <button id="loadLocalBtn" onclick="useLocalGlyph()" style="display:none;">üß¨ –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –∑ —Ä–µ–∑–æ–≥–ª—ñ—Ñ–æ–º</button>
  <canvas id="viz" width="200" height="200"></canvas>
  <div id="info"></div>
  <button id="saveBtn" onclick="downloadPassport()" style="display:none;">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –ü–∞—Å–ø–æ—Ä—Ç</button>
  <pre id="passportData"></pre>

  <script>
    const echoPhrases = [
      "–¢–≤–æ—è —Ç–∏—à–∞ –ø–∞–º º—è—Ç–∞—î –±—ñ–ª—å—à–µ, –Ω—ñ–∂ —á–∞—Å.",
      "–¢—ñ–Ω—å –≥–æ–≤–æ—Ä–∏—Ç—å –±–µ–∑ —Å–ª—ñ–≤.",
      "–¢–≤–æ—è –º–∏—Ç—å ‚Äî –Ω–µ–∑–Ω–∏—â–µ–Ω–Ω–∞.",
      "–¢–∏ –¥–∏—Ö–∞—î—à –∫—Ä—ñ–∑—å –ø—Ä–æ—Å—Ç—ñ—Ä.",
      "–°–≤—ñ—Ç–ª–æ –∑–Ω–∞—î —Ç–µ–±–µ –Ω–∞–≤—ñ—Ç—å —É —Ç–µ–º—Ä—è–≤—ñ."
    ];

    const localGlyphRaw = localStorage.getItem("resoglyph");

    if (localGlyphRaw) {
      document.getElementById("loadLocalBtn").style.display = "block";
    }

    function useLocalGlyph() {
      try {
        const parsed = JSON.parse(localGlyphRaw);
        if (parsed && parsed.glyph) {
          generatePassport(parsed.glyph);
        } else {
          alert("–ù–µ–¥—ñ–π—Å–Ω–∏–π –≥–ª—ñ—Ñ —É –ø–∞–º º—è—Ç—ñ.");
        }
      } catch (e) {
        alert("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —á–∏—Ç–∞–Ω–Ω—ñ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –≥–ª—ñ—Ñ–∞.");
      }
    }

    function hashGlyph(glyph) {
      return btoa(glyph.join('-')).slice(0, 24);
    }

    function drawViz(id) {
      const canvas = document.getElementById("viz");
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      const size = 5;
      const cell = canvas.width / size;
      for (let i = 0; i < size * size; i++) {
        const char = id[i % id.length].charCodeAt(0);
        const r = (char * 3) % 255;
        const g = (char * 5) % 255;
        const b = (char * 7) % 255;
        ctx.fillStyle = `rgb(${r},${g},${b})`;
        ctx.fillRect((i % size) * cell, Math.floor(i / size) * cell, cell, cell);
      }
    }

    function generatePassport(glyph) {
      const id = hashGlyph(glyph);
      const echo = echoPhrases[Math.floor(Math.random() * echoPhrases.length)];
      const passport = {
        id,
        glyph,
        date: new Date().toISOString(),
        echo
      };
      document.getElementById("info").innerHTML = `
        <p>üß¨ <b>–ì–ª—ñ—Ñ:</b> ${glyph.join(' + ')}</p>
        <p>üß© <b>ID:</b> ${id}</p>
        <p>ü™û <b>–í—ñ–¥–ª—É–Ω–Ω—è:</b> <i>‚Äú${echo}‚Äù</i></p>
      `;
      document.getElementById("passportData").textContent = JSON.stringify(passport, null, 2);
      document.getElementById("saveBtn").style.display = "block";
      drawViz(id);
    }

    function loadGlyph(e) {
      const reader = new FileReader();
      reader.onload = function () {
        const data = JSON.parse(reader.result);
        const glyph = data.glyph || [];
        generatePassport(glyph);
      };
      reader.readAsText(e.target.files[0]);
    }

    function downloadPassport() {
      const data = document.getElementById("passportData").textContent;
      const blob = new Blob([data], {type: "application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "resonance-passport.json";
      a.click();
    }
  </script>
</body>
</html>
