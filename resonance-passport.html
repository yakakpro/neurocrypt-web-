<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>ü™™ –†–µ–∑–æ–Ω–∞–Ω—Å-–ü–∞—Å–ø–æ—Ä—Ç</title>
  <style>
    body {
      background: #0c0c0c;
      color: #eee;
      font-family: 'Segoe UI', Arial, sans-serif;
      padding: 30px;
      max-width: 800px;
      margin: auto;
    }
    h2 { text-align: center; }
    button, input[type="file"] {
      background: #1a1a1a;
      color: #eee;
      padding: 10px;
      border: 1px solid #444;
      margin: 10px auto;
      display: block;
      cursor: pointer;
    }
    button:hover, input[type="file"]:hover { background: #333; }
    canvas {
      display: block;
      margin: 20px auto;
      border: 1px solid #555;
      background: #000;
      animation: glitch 4s infinite;
    }
    #qr-code {
      display: block;
      margin: 20px auto;
      animation: glitch 5s infinite;
    }
    @keyframes glitch {
      0% { transform: translate(0); opacity: 1; }
      2% { transform: translate(1px, 1px); opacity: 0.95; }
      4% { transform: translate(-1px, -1px); opacity: 0.95; }
      6% { transform: translate(0); opacity: 1; }
      100% { transform: translate(0); opacity: 1; }
    }
    pre {
      background: #111;
      padding: 10px;
      overflow-x: auto;
      margin-top: 20px;
    }
    #info { text-align: center; margin-top: 20px; }
  </style>
</head>
<body>
  <h2>ü™™ –°—Ç–≤–æ—Ä–∏—Ç–∏ –†–µ–∑–æ–Ω–∞–Ω—Å-–ü–∞—Å–ø–æ—Ä—Ç</h2>
  <p style="text-align:center;">–ó–∞–≤–∞–Ω—Ç–∞–∂ —Ñ–∞–π–ª –∞–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–π –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π –≥–ª—ñ—Ñ.</p>

  <input type="file" accept=".json" onchange="loadGlyph(event)">
  <button id="loadLocalBtn" onclick="useLocalGlyph()" style="display:none;">üß¨ –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –∑ —Ä–µ–∑–æ–≥–ª—ñ—Ñ–æ–º</button>
  <canvas id="viz" width="200" height="200"></canvas>
  <canvas id="qr-code" width="200" height="200" style="display:none;"></canvas>
  <div id="info"></div>
  <button id="saveBtn" onclick="downloadPassport()" style="display:none;">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –ü–∞—Å–ø–æ—Ä—Ç</button>
  <button id="savePngBtn" onclick="downloadPng()" style="display:none;">üñºÔ∏è –ó–±–µ—Ä–µ–≥—Ç–∏ –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—é</button>
  <button id="saveQrBtn" onclick="downloadQr()" style="display:none;">üì∑ –ó–±–µ—Ä–µ–≥—Ç–∏ QR</button>
  <pre id="passportData"></pre>

  <script src="https://cdn.jsdelivr.net/npm/kyber-js@0.2.0/dist/kyber.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script>
    const echoPhrases = [
      "–¢–≤–æ—è —Ç–∏—à–∞ –ø–∞–º º—è—Ç–∞—î –±—ñ–ª—å—à–µ, –Ω—ñ–∂ —á–∞—Å.",
      "–¢—ñ–Ω—å –≥–æ–≤–æ—Ä–∏—Ç—å –±–µ–∑ —Å–ª—ñ–≤.",
      "–¢–≤–æ—è –º–∏—Ç—å ‚Äî –Ω–µ–∑–Ω–∏—â–µ–Ω–Ω–∞.",
      "–¢–∏ –¥–∏—Ö–∞—î—à –∫—Ä—ñ–∑—å –ø—Ä–æ—Å—Ç—ñ—Ä.",
      "–°–≤—ñ—Ç–ª–æ –∑–Ω–∞—î —Ç–µ–±–µ –Ω–∞–≤—ñ—Ç—å —É —Ç–µ–º—Ä—è–≤—ñ."
    ];

    const localGlyphRaw = localStorage.getItem("resoglyph");
    let blobCache = null;

    if (localGlyphRaw) {
      document.getElementById("loadLocalBtn").style.display = "block";
    }

    function hashGlyph(glyph) {
      return btoa(glyph.join('-')).slice(0, 24);
    }

    function drawViz(id, glyph) {
      const canvas = document.getElementById("viz");
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      const size = Math.max(5, Math.ceil(glyph.length / 2));
      const cell = canvas.width / size;
      for (let i = 0; i < size * size; i++) {
        const char = id[i % id.length].charCodeAt(0);
        const gradient = ctx.createLinearGradient(0, 0, cell, cell);
        gradient.addColorStop(0, `rgb(${(char * 3) % 255}, 0, 255)`);
        gradient.addColorStop(1, `rgb(0, ${(char * 5) % 255}, 255)`);
        ctx.fillStyle = gradient;
        ctx.fillRect((i % size) * cell, Math.floor(i / size) * cell, cell, cell);
      }
    }

    function generateQR(id) {
      const qrCanvas = document.getElementById("qr-code");
      qrCanvas.style.display = "block";
      QRCode.toCanvas(qrCanvas, `/validate.html?id=${id}`, { width: 200, color: { dark: '#0ff', light: '#000' } }, (err) => {
        if (err) console.error(err);
      });
    }

    async function signData(data) {
      const encoder = new TextEncoder();
      const hash = btoa(String.fromCharCode(...encoder.encode(data)));
      return hash.slice(0, 32);
    }

    async function generatePassport(glyph) {
      if (!glyph || glyph.length < 7) {
        alert("–ì–ª—ñ—Ñ –Ω–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π –∞–±–æ –Ω–µ–ø–æ–≤–Ω–∏–π.");
        return;
      }
      const id = hashGlyph(glyph);
      const echo = echoPhrases[Math.floor(Math.random() * echoPhrases.length)];
      const passport = {
        id,
        glyph,
        date: new Date().toISOString(),
        echo
      };
      const kyber = new Kyber.Kyber512();
      const { publicKey, secretKey } = await kyber.keygen();
      const encrypted = await kyber.encrypt(publicKey, JSON.stringify(passport));
      const encryptedStr = btoa(String.fromCharCode(...encrypted));
      const signature = await signData(encryptedStr);
      const finalPassport = { encrypted: encryptedStr, signature, publicKey: btoa(String.fromCharCode(...publicKey)) };
      document.getElementById("info").innerHTML = `
        <p>üß¨ <b>–ì–ª—ñ—Ñ:</b> ${glyph.join(' + ')}</p>
        <p>üß© <b>ID:</b> ${id}</p>
        <p>ü™û <b>–í—ñ–¥–ª—É–Ω–Ω—è:</b> <i>‚Äú${echo}‚Äù</i></p>
        <p>üîí <b>–ü—ñ–¥–ø–∏—Å:</b> ${signature.slice(0, 8)}...</p>
      `;
      document.getElementById("passportData").textContent = JSON.stringify(finalPassport, null, 2);
      document.getElementById("saveBtn").style.display = "block";
      document.getElementById("savePngBtn").style.display = "block";
      document.getElementById("saveQrBtn").style.display = "block";
      drawViz(id, glyph);
      generateQR(id);
    }

    async function loadGlyph(e) {
      const reader = new FileReader();
      reader.onload = async function () {
        try {
          const data = JSON.parse(reader.result);
          const glyph = data.glyph || (data.encrypted ? JSON.parse(atob(data.encrypted)).glyph : []);
          if (!glyph.length) throw new Error("–ì–ª—ñ—Ñ –ø–æ—Ä–æ–∂–Ω—ñ–π –∞–±–æ –Ω–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π.");
          generatePassport(glyph);
        } catch (e) {
          alert("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Ñ–∞–π–ª—É: " + e.message);
        }
      };
      reader.readAsText(e.target.files[0]);
    }

    async function useLocalGlyph() {
      try {
        const parsed = JSON.parse(localGlyphRaw);
        const glyph = parsed.glyph || (parsed.encrypted ? JSON.parse(atob(parsed.encrypted)).glyph : []);
        if (!glyph.length) throw new Error("–ì–ª—ñ—Ñ –ø–æ—Ä–æ–∂–Ω—ñ–π –∞–±–æ –Ω–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π.");
        generatePassport(glyph);
      } catch (e) {
        alert("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —á–∏—Ç–∞–Ω–Ω—ñ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –≥–ª—ñ—Ñ–∞: " + e.message);
      }
    }

    function downloadPassport() {
      if (!blobCache) {
        const data = document.getElementById("passportData").textContent;
        blobCache = new Blob([data], {type: "application/json"});
      }
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blobCache);
      a.download = "resonance-passport.json";
      a.click();
    }

    function downloadPng() {
      const canvas = document.getElementById("viz");
      const a = document.createElement("a");
      a.href = canvas.toDataURL("image/png");
      a.download = "resonance-passport.png";
      a.click();
    }

    function downloadQr() {
      const canvas = document.getElementById("qr-code");
      const a = document.createElement("a");
      a.href = canvas.toDataURL("image/png");
      a.download = "resonance-passport-qr.png";
      a.click();
    }
  </script>
</body>
</html>
