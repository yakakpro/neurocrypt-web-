<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>Resonance Gate</title>
  <style>
    body {
      background: #0d0d0d;
      color: #e0e0e0;
      font-family: 'Segoe UI', Arial, sans-serif;
      padding: 30px;
      max-width: 700px;
      margin: auto;
    }
    h2 { text-align: center; animation: glitch 3s infinite; }
    .question { margin: 25px 0; }
    button {
      background: #1a1a1a;
      color: #e0e0e0;
      padding: 10px 20px;
      border: 1px solid #444;
      margin: 5px;
      cursor: pointer;
      position: relative;
      transition: all 0.2s;
    }
    button:hover { background: #333; }
    button.glitch::after {
      content: attr(data-text);
      position: absolute;
      left: 2px;
      top: 2px;
      color: #0ff;
      opacity: 0.5;
      animation: glitch 4s infinite;
    }
    @keyframes glitch {
      0% { transform: translate(0); opacity: 0.5; }
      2% { transform: translate(1px, 1px); opacity: 0.3; }
      4% { transform: translate(-1px, -1px); opacity: 0.5; }
      6% { transform: translate(0); opacity: 0.3; }
      100% { transform: translate(0); opacity: 0.5; }
    }
    #result { text-align: center; font-size: 1.2em; margin-top: 30px; }
    #qr-passport, #qr-validate {
      display: block;
      margin: 20px auto;
      animation: glitch 5s infinite;
    }
    pre {
      background: #111;
      padding: 10px;
      overflow-x: auto;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h2>üåå Resonance Gate</h2>
  <p style="text-align:center;">–¶–µ –Ω–µ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞. –¶–µ –¥–∑–µ—Ä–∫–∞–ª–æ.</p>

  <div id="gate"></div>
  <div id="result"></div>
  <canvas id="qr-passport" width="200" height="200" style="display:none;"></canvas>
  <canvas id="qr-validate" width="200" height="200" style="display:none;"></canvas>
  <pre id="export" style="display:none;"></pre>
  <button id="download" style="display:none;" onclick="downloadJSON()">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ —Ä–µ–∑–æ–≥–ª—ñ—Ñ</button>

  <script src="https://cdn.jsdelivr.net/npm/kyber-js@0.2.0/dist/kyber.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script>
    const questions = [
      { q: "–©–æ –±—ñ–ª—å—à–µ —Å—Ö–æ–∂–µ –Ω–∞ —Å–ø–æ–∫—ñ–π?", a: ["–≤–æ–¥–∞", "–¥–∑–≤—ñ–Ω", "–≤–æ–≥–æ–Ω—å", "–ø–æ—Ä–æ–∂–Ω–µ—á–∞"] },
      { q: "–©–æ –∑–≤—É—á–∏—Ç—å, –∫–æ–ª–∏ —Ç–∏ –º–æ–≤—á–∏—à?", a: ["–≤—ñ—Ç–µ—Ä", "—Å–≤—ñ—Ç–ª–æ", "—Å–µ–±–µ", "–Ω—ñ—á"] },
      { q: "–Ø–∫–µ –∑ —Ü–∏—Ö –Ω–µ —Ç–≤–æ—î?", a: ["—à—É–º", "–∫–∞–º–µ–Ω—é–∫–∞", "–¥—É–º–∫–∞", "–ø—ñ—Å–æ–∫"] },
      { q: "–©–æ –Ω–µ –º–æ–∂–Ω–∞ –≤—Ç—Ä–∏–º–∞—Ç–∏?", a: ["–º–∏—Ç—å", "—Å–æ–Ω", "—Ç—ñ–Ω—å", "—Å–ø–æ–≥–∞–¥"] },
      { q: "–©–æ —Ö–æ—á–µ –∑–∞–ª–∏—à–∏—Ç–∏—Å—è?", a: ["—Å–ª–æ–≤–æ", "–º–∏—Ç—å", "–≤–æ–≥–æ–Ω—å", "—Å–ø–æ–∫—ñ–π"] },
      { q: "–Ø–∫–∏–π —Å–∏–º–≤–æ–ª –∑–∞—Ä–∞–∑ –±–ª–∏–∂—á–∏–π?", a: ["üåä", "üî•", "üåë", "üí®"] },
      { q: "–ö—É–¥–∏ –≤–µ–¥–µ —Ü—è —Ñ—Ä–∞–∑–∞: ¬´—Ç–∏—Ö–∞ —Ç–∏—à–∞ —Ç–∏—Å–Ω–µ¬ª?", a: ["—É—Å–µ—Ä–µ–¥–∏–Ω—É", "–Ω–∞–∑–æ–≤–Ω—ñ", "–≤–≥–æ—Ä—É", "–≤ –Ω—ñ–∫—É–¥–∏"] },
      { q: "–©–æ –ª–∏—à–∞—î—Ç—å—Å—è –ø—ñ—Å–ª—è —Ç–µ–±–µ?", a: ["–≥–æ–ª–æ—Å", "—Å–ª—ñ–ø–æ—Ç–∞", "–∫–æ–ª–æ", "—Ä—É—Ö"] },
      { q: "–©–æ –Ω–µ –º–∞—î —Ñ–æ—Ä–º–∏, –∞–ª–µ —Ç—Ä–∏–º–∞—î?", a: ["–ø–∞–º º—è—Ç—å", "–¥–∏—Ö–∞–Ω–Ω—è", "–¥—É–º–∫–∞", "—Å–æ–Ω"] },
      { q: "–ö–æ–ª–∏ —Å–≤—ñ—Ç –∑–≥–∞—Å–∞—î, –∑ º—è–≤–ª—è—î—Ç—å—Å—è...", a: ["–∑—ñ—Ä–∫–∞", "—è", "–ø–æ—Ä–æ–∂–Ω–µ—á–∞", "–¥–∂–µ—Ä–µ–ª–æ"] },
      { q: "–©–æ –∑–Ω–∏–∫–∞—î, –∫–æ–ª–∏ –¥–∏–≤–∏—à—Å—è –ø—Ä—è–º–æ?", a: ["—Å—Ç—Ä–∞—Ö", "—Ç—ñ–Ω—å", "—ñ–ª—é–∑—ñ—è", "–≤–æ–≥–æ–Ω—å"] }
    ];

    const good = ["–≤–æ–¥–∞", "–¥–∑–≤—ñ–Ω", "–ø–æ—Ä–æ–∂–Ω–µ—á–∞", "—Å–µ–±–µ", "–º–∏—Ç—å", "—Å–ø–æ–∫—ñ–π", "üåë", "—É—Å–µ—Ä–µ–¥–∏–Ω—É", "–ø–∞–º º—è—Ç—å", "–∑—ñ—Ä–∫–∞", "—ñ–ª—é–∑—ñ—è"];

    const gate = document.getElementById("gate");
    const result = document.getElementById("result");
    const exportBox = document.getElementById("export");
    const downloadBtn = document.getElementById("download");
    const qrPassport = document.getElementById("qr-passport");
    const qrValidate = document.getElementById("qr-validate");

    let index = 0;
    let answers = [];
    let glyph = [];
    let startTime = Date.now();
    let blobCache = null;

    const selected = questions.sort(() => 0.5 - Math.random()).slice(0, 7);
    const ritualMode = localStorage.getItem("ritualMode") === "true";

    async function signData(data) {
      const encoder = new TextEncoder();
      const hash = btoa(String.fromCharCode(...encoder.encode(data)));
      return hash.slice(0, 32);
    }

    function generateMultiQR(id) {
      QRCode.toCanvas(qrPassport, `resonance-passport.html?id=${id}`, { width: 200, color: { dark: '#0ff', light: '#000' } }, (err) => {
        if (err) console.error(err);
      });
      QRCode.toCanvas(qrValidate, `validate.html?id=${id}`, { width: 200, color: { dark: '#0ff', light: '#000' } }, (err) => {
        if (err) console.error(err);
      });
      qrPassport.style.display = "block";
      qrValidate.style.display = "block";
    }

    function showQuestion() {
      if (index >= selected.length) return evaluate();

      const q = selected[index];
      const div = document.createElement("div");
      div.className = "question";
      div.innerHTML = `<p><b>${index + 1}.</b> ${q.q}</p>`;
      q.a.forEach(opt => {
        const btn = document.createElement("button");
        btn.textContent = opt;
        btn.setAttribute("data-text", opt);
        btn.classList.add("glitch");
        btn.onclick = () => {
          const time = Date.now() - startTime;
          answers.push({ a: opt, t: time });
          glyph.push(opt);
          index++;
          gate.innerHTML = '';
          startTime = Date.now();
          showQuestion();
        };
        div.appendChild(btn);
      });
      gate.appendChild(div);
    }

    async function evaluate() {
      gate.innerHTML = '';
      let score = 0;
      let fast = 0;
      answers.forEach(x => {
        if (x.t < 800) fast++;
        if (good.includes(x.a)) score++;
      });

      let state = "", msg = "";
      if (score >= 5 && fast < 3) {
        state = "üåï –ü–æ–≤–Ω–∏–π —Ä–µ–∑–æ–Ω–∞–Ω—Å";
        msg = "–¢–∏ –Ω–∞ —á–∞—Å—Ç–æ—Ç—ñ. –í—ñ—Ç–∞—é.";
      } else if (score >= 3) {
        state = "üåó –ö–æ–ª–∏–≤–∞–Ω–Ω—è";
        msg = "–¢–∏ –±–ª–∏–∑—å–∫–æ, –∞–ª–µ —â–æ—Å—å —â–µ —à—É–∫–∞—î —Å–µ–±–µ.";
      } else {
        state = "üåë –ù–µ—Å—É–º—ñ—Å–Ω—ñ—Å—Ç—å";
        msg = "–¢–≤–æ—è —Ö–≤–∏–ª—è —â–µ –Ω–µ –∑–±—ñ–≥–ª–∞—Å—å.";
      }

      const payload = {
        glyph,
        timestamp: new Date().toISOString(),
        resonance: state
      };

      const kyber = new Kyber.Kyber512();
      const { publicKey, secretKey } = await kyber.keygen();
      const encrypted = await kyber.encrypt(publicKey, JSON.stringify(payload));
      const encryptedStr = btoa(String.fromCharCode(...encrypted));
      const signature = await signData(encryptedStr);
      const finalPayload = { encrypted: encryptedStr, signature, publicKey: btoa(String.fromCharCode(...publicKey)) };

      localStorage.setItem("resoglyph", JSON.stringify(finalPayload));
      localStorage.setItem("resonanceState", state);

      const id = btoa(glyph.join('-')).slice(0, 24);
      result.innerHTML = `<b>${state}</b><br><br>üß¨ –¢–≤—ñ–π —Ä–µ–∑–æ–≥–ª—ñ—Ñ: <i>${glyph.join(" + ")}</i><br>üß© <b>ID:</b> ${id}<br>üîí <b>–ü—ñ–¥–ø–∏—Å:</b> ${signature.slice(0, 8)}...<br>üåÄ ${msg}`;
      generateMultiQR(id);
      exportBox.style.display = "block";
      exportBox.textContent = JSON.stringify(finalPayload, null, 2);
      downloadBtn.style.display = "inline-block";

      if (ritualMode) {
        setTimeout(() => {
          window.open("resonance-passport.html", "_blank");
        }, 2000);
      }
    }

    function downloadJSON() {
      if (!blobCache) {
        blobCache = new Blob([exportBox.textContent], {type: "application/json"});
      }
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blobCache);
      a.download = "resoglyph.json";
      a.click();
    }

    showQuestion();
  </script>
</body>
</html>
